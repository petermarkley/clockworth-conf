<!DOCTYPE html>
<html>
	<head>
		<title>Clockworth Configurator</title>
		<style>
			body {
				background-color: #232221;
				background-image: linear-gradient(to bottom, rgba(0,0,0,0.4), rgba(0,0,0,0.4)), linear-gradient(to bottom, rgba(57,56,54,0), rgba(57,56,54,1)), url("img/clockworth-paper-bg.jpg");
				background-position: top center;
				background-repeat: no-repeat;
				background-size: 100vw 100vh, 100vw 100vh;
				color: #b6b6b6;
				font-family: Baskerville, serif;
				padding: 0;
				margin: 0;
			}
			a {
				color: #fff;
				text-decoration: none;
				cursor: pointer;
			}
			a:hover, a:active, a:focus {
				color: #ddd;
			}
			main {
				max-width: 800px;
				margin: 16px auto;
				background-color: #323232;
				padding: 16px;
				border-radius: 8px;
				box-shadow: 0 4px 8px rgba(0,0,0,0.5);
				position: relative;
				z-index: 10;
			}
			footer {
				position: relative;
				z-index: 10;
			}
			h1 {
				font-family: "Brush Script MT", cursive;
				font-size: 48px;
				margin: 0;
				text-align: center;
				font-style: italic;
			}
			h2 {
				text-align: center;
				margin: 0 0 8px 0;
				font-weight: normal;
				font-size: 24px;
				letter-spacing: 4px;
			}
			h3 {
				margin: 0;
			}
			footer {
				font-size: 1em;
				font-style: italic;
				color: rgba(255,255,255,0.4);
				text-align: center;
			}
			footer a {
				color: rgba(255,255,255,0.8);
			}
			footer a:hover, footer a:active, footer a:focus {
				color: rgba(255,255,255,0.6);
			}
			.inset {
				background-color: #2c2c2c;
				box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
				padding: 8px;
				border-radius: 4px;
				overflow-y: scroll;
				margin: 0 0 8px 0;
			}
			.inset-flat {
				width: 100%;
				box-sizing: border-box;
				background-color: #2c2c2c;
				padding: 8px;
			}
			.inset-flat>* {
				border-left: 2px solid #393836;
				padding-left: 8px;
			}
			.inset-flat>*:first-child {
				border-left: none;
				padding-left: 0;
			}
			.inset-flat h5 {
				font-size: 16px;
			}
			.inset-flat-heading {
				width: 100%;
				box-sizing: border-box;
				background-color: #393836;
				text-align: center;
				padding: 4px 8px;
				font-size: 16px;
			}
			.inset-flat-container {
				border-radius: 6px;
				overflow: hidden;
			}
			#chime_events, #chime_events ul {
				list-style-type: none;
				padding: 0;
				margin: 0;
				display: flex;
				flex-direction: column;
				gap: 4px;
				overflow: visible;
			}
			#chime_events ul {
				padding: 0 0 0 26px;
				margin: 0;
			}
			#chime_events li {
				margin: 0;
				padding: 0;
				display: flex;
				flex-direction: column;
				gap: 4px;
				align-items: flex-start;
			}
			.event-heading {
				display: flex;
				flex-direction: row;
				gap: 8px;
				align-items: baseline;
			}
			.drawer-button {
				cursor: pointer;
			}
			.drawer-button.open {
				transform: rotate(90deg);
			}
			#chime_events ul {
				display: none;
				transform: scaleY(0);
			}
			#chime_events ul.open {
				display: flex;
				transform: scaleY(1.0);
			}
			.event-bar {
				margin: 0;
				padding: 4px 8px;
				background-color: #393836;
				border-radius: 8px;
				cursor: pointer;
			}
			.event-bar:hover, .event-bar:focus {
				background-color: #4d4d4c;
			}
			.event-bar.selected {
				background-color: #b6b6b6;
				color: #393836;
			}
			.event-bar.selected:hover, .event-bar.selected:focus {
				background-color: #fff;
			}
			.disable .event-bar {
				opacity: 0.3;
			}
			.hierarchy-parent {
				position: absolute;
				pointer-events: none;
				top: -2em;
				height: 3em;
				box-sizing: border-box;
				border-left: 2px solid #4d4d4c;
			}
			.hierarchy-item {
				position: absolute;
				pointer-events: none;
				left: -22px;
				top: -2em;
				width: 12px;
				height: 3em;
				box-sizing: border-box;
				border-bottom: 2px solid #4d4d4c;
				border-left: 2px solid #4d4d4c;
				border-bottom-left-radius: 8px;
			}
			#collision_sequence {
				list-style-type: none;
				margin: 0;
				padding: 0;
			}
			.collision-list {
				list-style-type: none;
				margin: 0 0 0 16px;
				padding: 0;
				display: flex;
				flex-direction: row;
				flex-wrap: wrap;
				justify-content: flex-start;
				gap: 4px;
			}
			.collision-item {
				margin: 0;
				padding: 4px 8px;
				background-color: #393836;
				border-radius: 8px;
				cursor: pointer;
				display: flex;
				flex-direction: row;
				gap: 4px;
				align-items: baseline;
			}
			.collision-item:hover, .collision-item:focus {
				background-color: #4d4d4c;
			}
			.collision-item.selected {
				background-color: #b6b6b6;
				color: #393836;
			}
			.collision-item.selected:hover, .collision-item.selected:focus {
				background-color: #fff;
			}
			.collision-item.disable {
				opacity: 0.3;
			}
			button {
				appearance: none;
				border: none;
				background-color: #b6b6b6;
				color: #393836;
				margin: 0;
				padding: 8px;
				display: flex;
				justify-content: center;
				align-items: center;
				border-radius: 4px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.5);
				cursor: pointer;
			}
			button:hover, button:focus {
				background-color: #fff;
			}
			button:active {
				background-color: #b6b6b6;
				box-shadow: 0 1px 2px rgba(0,0,0,1.0);
				transform: translate( 0, 1px );
			}
			button:disabled {
				background-color: #b6b6b6;
				opacity: 0.5;
				cursor: default;
				transform: none;
			}
			button.secondary {
				background-color: #393836;
				color: #fff;
			}
			button.secondary:hover, button.secondary:focus {
				background-color: #4d4d4c;
			}
			button.secondary:active {
				background-color: #393836;
			}
			button.secondary:disabled {
				background-color: #393836;
			}
			.toolbar {
				display: flex;
				flex-direction: row;
				gap: 4px;
			}
			.toolbar button {
				appearance: none;
				border: none;
				background-color: #393836;
				color: #fff;
				margin: 0;
				width: 48px;
				height: 40px;
				display: flex;
				justify-content: center;
				align-items: center;
				border-radius: 4px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.5);
				cursor: pointer;
			}
			.toolbar button:hover, .toolbar button:focus {
				background-color: #4d4d4c;
			}
			.toolbar button:active {
				background-color: #393836;
				box-shadow: 0 1px 2px rgba(0,0,0,1.0);
				transform: translate( 0, 1px );
			}
			.toolbar button.leftmost {
				border-bottom-left-radius: 8px;
			}
			.toolbar button.rightmost {
				border-bottom-right-radius: 8px;
			}
			.toolbar button:disabled {
				background-color: #393836;
				opacity: 0.5;
				cursor: default;
				transform: none;
			}
			.properties_heading {
				display: flex;
				flex-direction: row;
				justify-content: space-between;
				padding-bottom: 16px;
				flex-grow: 1;
			}
			#breadcrumb, #breadcrumb span, #breadcrumb a {
				font-size: 12px;
				font-weight: normal;
				display: inline-flex;
				flex-direction: row;
				justify-content: flex-start;
				gap: 8px;
				align-items: center;
			}
			#breadcrumb {
				flex-wrap: wrap;
			}
			#properties_title {
				appearance: none;
				border: none;
				background: none;
				font-size: 19px;
				font-weight: bold;
				color: #b6b6b6;
				font-family: inherit;
				width: auto;
			}
			#properties_type {
				font-weight: normal;
				font-style: italic;
			}
			#properties {
				min-height: 300px;
				display: flex;
				flex-direction: column;
				gap: 16px;
			}
			
			/* input toggle */
			.switch {
				position: relative;
				display: inline-block;
				width: 60px;
				height: 34px;
			}
			.switch input {
				opacity: 0;
				width: 0;
				height: 0;
			}
			.slider {
				position: absolute;
				cursor: pointer;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: #4d4d4c;
				-webkit-transition: .4s;
				transition: .4s;
				border-radius: 34px;
				box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
			}
			.slider:before {
				position: absolute;
				content: "";
				height: 26px;
				width: 26px;
				left: 4px;
				bottom: 4px;
				background-color: #323232;
				-webkit-transition: .4s;
				transition: .4s;
				border-radius: 50%;
				box-shadow: 0 1px 2px rgba(0,0,0,0.5);
			}
			input:checked + .slider {
				background-color: #b6b6b6;
			}
			input:focus + .slider {
				box-shadow: 0 0 1px #b6b6b6;
			}
			input:checked + .slider:before {
				-webkit-transform: translateX(26px);
				-ms-transform: translateX(26px);
				transform: translateX(26px);
			}
			
			/* page 3 styles */
			#json_output {
				color: inherit;
				font-weight: bold;
				width: 100%;
				height: 150px;
				box-sizing: border-box;
				resize: none;
				appearance: none;
				border: none;
				border-radius: 4px;
				background-color: #2c2c2c;
				box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
				padding: 8px;
				border-radius: 4px;
				overflow-y: scroll;
			}
			
			/* modal styles */
			#modal {
				position: absolute;
				overflow: hidden;
				z-index: 20;
				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
				width: 100vw;
				height: 100vh;
			}
			#modal-bg {
				position: absolute;
				overflow: hidden;
				background-color: rgba(0,0,0,0.75);
				cursor: pointer;
				width: 100vw;
				height: 100vh;
				backdrop-filter: blur(4px);
			}
			#modal-panel {
				background-color: #323232;
				padding: 16px;
				border-radius: 8px;
				box-shadow: 0 4px 8px rgba(0,0,0,0.5);
				z-index: 0;
				width: 600px;
				display: flex;
				flex-direction: column;
				gap: 16px;
			}
			#modal-panel fieldset, .fieldset {
				border-radius: 16px;
				border: 2px solid #4d4d4c;
				position: relative;
				padding: 24px;
				margin: 0.5em 0 0 0;
				overflow: visible;
				display: flex;
				flex-direction: row;
				gap: 24px;
				justify-content: center;
				align-items: center;
			}
			#modal-panel fieldset h4, .fieldset h4 {
				margin: 0;
				padding: 0 8px;
				position: absolute;
				top: -0.75em;
				left: 16px;
				background-color: #323232;
			}
			
			/* form element styles */
			input[type="text"], input[type="number"] {
				appearance: none;
				border: none;
				font-size: inherit;
				color: #b6b6b6;
				font-family: inherit;
				background-color: #2c2c2c;
				box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
				padding: 8px;
				border-radius: 4px;
				box-sizing: border-box;
			}
			label {
				font-size: 14px;
			}
			.select-container {
				position: relative;
			}
			.select-container::after {
				content: '\25BC';
				position: absolute;
				right: 0.5rem;
				top: 0.5rem;
				pointer-events: none;
				font-size: 12px;
			}
			select {
				appearance: none;
				background-color: #393836;
				color: #fff;
				border: none;
				margin: 0;
				padding: 8px;
				padding-right: 2.5em;
				display: flex;
				justify-content: center;
				align-items: center;
				border-radius: 4px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.5);
				cursor: pointer;
				font-family: inherit;
				font-weight: normal;
				width: 100%;
			}
			select:hover, select:focus {
				background-color: #4d4d4c;
			}
			select:active {
				background-color: #393836;
			}
			[v-cloak] { display: none }
		</style>
	</head>
	<body>
		<div id="app" :style="(store.modal.show?'position:fixed;width:100vw;top:'+(-store.modal.scroll)+'px':'')">
			<main>
				<div style="display:flex;flex-direction:column;align-items:center;margin-bottom:16px;">
					<h1>Clockworth Configurator</h1>
					<p>Widget for configuring your own <a href="https://github.com/petermarkley/clockworth">Clockworth robotic clock</a>.</p>
					<img src="img/clockworth-photo-alpha-300px.png" alt="Clockworth" style="width:200px;height:auto;"/>
				</div>
				<template v-if="page==0">
					<div style="display:flex;flex-direction:column;align-items:center;margin-bottom:16px;gap:16px;">
						<p>How would you like to begin?</p>
						<div style="display:flex;flex-direction:column;justify-content:space-between;gap:12px;width:60%;">
							<button style="flex:1;display:flex;flex-direction:row;gap:8px;font-size:18px;" @click="importDefault(); page++;">
								<svg viewBox="0 0 24 24" style="width:1em;height:1em;">
									<use href="img/icons.svg#bookmark"/>
								</svg>
								<span>Use Default</span>
							</button>
							<button style="flex:1;display:flex;flex-direction:row;gap:8px;font-size:18px;" @click="uploadConf">
								<svg viewBox="0 0 24 24" style="width:1em;height:1em;">
									<use href="img/icons.svg#download" style="transform:scaleY(-1);transform-origin:center;"/>
								</svg>
								<span>Upload</span>
							</button>
							<button style="flex:1;display:flex;flex-direction:row;gap:8px;font-size:18px;" @click="page++;">
								<svg viewBox="0 0 24 24" style="width:1em;height:1em;">
									<use href="img/icons.svg#page"/>
								</svg>
								<span>Start from Scratch</span>
							</button>
						</div>
					</div>
				</template>
				<template v-else-if="page==1">
					<div style="display:flex;flex-direction:row;gap:16px;margin-bottom:24px;">
						<div style="width:100%;">
							<h2>Chime Events</h2>
							<div class="inset" style="height:300px;">
								<ul id="chime_events">
									<chime-event
										v-for="(event, index) in store.conf.events"
										:event="event"
										:index="index"
										:depth="0"
										:has-next-sibling="false"
										:path="[]"
									></chime-event>
								</ul>
							</div>
							<div class="toolbar">
								<button
									id="toolbar_add"
									class="leftmost"
									@click="store.newEvent"
									title="Add new chime object"
								>
									<span>+</span>
								</button>
								<button
									id="toolbar_remove"
									:disabled="!store.selection.event"
									@click="store.deleteEvent"
									title="Delete this chime object"
								>
									<span>-</span>
								</button>
								<button
									id="toolbar_unindent"
									:disabled="!store.selection.event || store.selection.path.length == 0"
									@click="store.decreaseIndent"
									title="Decrease indent"
								>
									<span>&larr;</span>
								</button>
								<button
									id="toolbar_indent"
									:disabled="!store.selection.event"
									@click="store.increaseIndent"
									title="Increase indent"
								>
									<span>&rarr;</span>
								</button>
								<button
									id="toolbar_up"
									:disabled="!store.selection.event || store.selection.path[store.selection.path.length-1].index == 0"
									@click="store.moveUpward"
									title="Move upward in list"
								>
									<span>&uarr;</span>
								</button>
								<button
									id="toolbar_down"
									class="rightmost"
									:disabled="!store.selection.event ||
										store.selection.path.length < 2 && (store.selection.path[store.selection.path.length-1].index == store.conf.events.length-1) ||
										store.selection.path.length > 1 && (store.selection.path[store.selection.path.length-1].index == store.selection.path[store.selection.path.length-2].event.members.length-1)"
									@click="store.moveDownward"
									title="Move downward in list"
								>
									<span>&darr;</span>
								</button>
							</div>
						</div>
						<div style="width:100%;">
							<h2 style="display:flex;flex-direction:row;justify-content:center;align-items:center;gap:16px;">
								<span>Overlap Slots</span>
								<a @click="overlapSlotsHelp" title="What are &quot;Overlap Slots?&quot;" style="display:flex;">
									<svg viewBox="0 0 24 24" style="width:1em;height:1em;">
										<use href="img/icons.svg#help"/>
									</svg>
								</a>
							</h2>
							<div class="inset" style="height:300px;">
								<ol id="collision_sequence">
									<li v-for="(n, i) in 10">
										<span>Slot {{ n }}:</span>
										<ul class="collision-list">
											<li
												v-for="item in getCollisionList(n,store.conf.events,true,[])"
												@click="store.select"
												:data-path="JSON.stringify(item.path)"
												:class="'collision-item selectable'+(store.selection.event===item.event?' selected':'')+(item.enable?'':' disable')"
											>
												<svg viewBox="0 0 24 24" style="width:1em;height:1em;">
													<use href="img/icons.svg#music"/>
												</svg>
												<span>{{ item.event.label }}</span>
											</li>
										</ul>
									</li>
								</ol>
							</div>
							<div class="toolbar">
								<button
									id="toolbar_prev"
									class="leftmost"
									:disabled="!store.selection.event || store.selection.event.type != 'event' || store.selection.event.sequence < 2"
									@click="store.selection.event.sequence--;"
									title="Move to previous sequence slot"
								>
									<span>&uarr;</span>
								</button>
								<button
									id="toolbar_next"
									class="rightmost"
									:disabled="!store.selection.event || store.selection.event.type != 'event' || store.selection.event.sequence > 9"
									@click="store.selection.event.sequence++;"
									title="Move to next sequence slot"
								>
									<span>&darr;</span>
								</button>
							</div>
						</div>
					</div>
					<div>
						<div v-if="store.selection.event" style="display:flex;flex-direction:row;gap:16px;margin-bottom:16px;">
							<div class="properties_heading">
								<h3 style="display:flex;flex-direction:row;gap:16px;align-items:center;">
									<a @click="store.deselect" title="Deselect" style="font-size:24px;">
										<svg viewBox="0 0 20 20" style="width:1em;height:1em;">
											<use href="img/icons.svg#x-circle"/>
										</svg>
									</a>
									<span id="breadcrumb">
										<template v-for="(item, i) in store.selection.path">
											<span v-if="i<(store.selection.path.length-1)">
												<a @click="store.select" class="selectable" :data-path="JSON.stringify(store.cleanPath().slice(0,i+1))">
													<svg viewBox="0 0 24 24" style="width:1em;height:1em;">
														<use href="img/icons.svg#folder"/>
													</svg>
													<span>{{ item.event.label }}</span>
												</a>
												<span>&rarr;</span>
											</span>
										</template>
									</span>
									<span style="display:inline-flex;flex-direction:row;gap:8px;align-items:center;">
										<svg v-if="store.selection.event.type=='group'" viewBox="0 0 24 24" style="width:1em;height:1em;">
											<use href="img/icons.svg#folder"/>
										</svg>
										<svg v-else-if="store.selection.event.type=='event'" viewBox="0 0 24 24" style="width:1em;height:1em;">
											<use href="img/icons.svg#music"/>
										</svg>
										<input type="text" id="properties_title" v-model="store.selection.event.label"/>
									</span>
								</h3>
							</div>
							<label class="switch">
								<input type="checkbox" id="properties_enable" v-model="store.selection.event.enable">
								<span class="slider" :title="(store.selection.event.enable?'Click to disable':'Click to enable')"></span>
							</label>
						</div>
						<div id="properties">
							<template v-if="store.selection.event && store.selection.event.type == 'group'">
								<p style="font-style:italic;">Contains {{ getEventCount(store.selection.event) }} chime events.</p>
							</template>
							<template v-else-if="store.selection.event && store.selection.event.type == 'event'">
								<div class="fieldset" style="flex-direction:column;align-items:stretch;">
									<h4>Match Rules</h4>
									<div class="inset-flat-container" style="display:flex;flex-direction:column;flex-grow:1;align-items:center">
										<h5 class="inset-flat-heading" style="margin:0;">Date</h5>
										<div class="inset-flat" style="display:flex;flex-direction:row;gap:16px 8px;flex-wrap:wrap;align-items:flex-start;">
											<div style="display:flex;flex-direction:row;gap:8px;align-items:center;">
												<label for="match_date_type">Type</label>
												<div class="select-container">
													<select id="match_date_type" v-model="store.selection.event.match.date.type">
														<option value="all">all</option>
														<option value="specify">specify</option>
														<option value="easter">Easter</option>
													</select>
												</div>
											</div>
											<template v-if="store.selection.event.match.date.type == 'specify'">
												<div style="display:flex;flex-direction:column;gap:8px;">
													<h5 style="margin:0;">Month</h5>
													<div style="display:flex;flex-direction:row;gap:8px;align-items:center;">
														<label for="match_date_specify_month_type">Type</label>
														<div class="select-container">
															<select id="match_date_specify_month_type" v-model="store.selection.event.match.date.month.type">
																<option value="specify">specify</option>
															</select>
														</div>
													</div>
													<div style="display:flex;flex-direction:row;gap:8px;align-items:center;">
														<label for="match_date_specify_month_value">Value</label>
														<div class="select-container">
															<select id="match_date_specify_month_value" v-model="store.selection.event.match.date.month.value">
																<option value="Jan">January</option>
																<option value="Feb">February</option>
																<option value="Mar">March</option>
																<option value="Apr">April</option>
																<option value="May">May</option>
																<option value="Jun">June</option>
																<option value="Jul">July</option>
																<option value="Aug">August</option>
																<option value="Sep">September</option>
																<option value="Oct">October</option>
																<option value="Nov">November</option>
																<option value="Dec">December</option>
															</select>
														</div>
													</div>
												</div>
												<div style="display:flex;flex-direction:column;gap:8px;">
													<h5 style="margin:0;">Day</h5>
													<div style="display:flex;flex-direction:row;gap:8px;align-items:center;">
														<label for="match_date_specify_day_type">Type</label>
														<div class="select-container">
															<select id="match_date_specify_day_type" v-model="store.selection.event.match.date.day.type">
																<option value="fixed">fixed</option>
																<option value="floating">floating</option>
															</select>
														</div>
													</div>
													<template v-if="store.selection.event.match.date.day.type == 'fixed'">
														<div style="display:flex;flex-direction:row;gap:8px;align-items:center;">
															<label for="match_date_specify_day_value">Value</label>
															<input type="number" min="1" max="31" step="1" id="match_date_specify_day_value" v-model="store.selection.event.match.date.day.value"/>
														</div>
													</template>
													<template v-else-if="store.selection.event.match.date.day.type == 'floating'">
														<div style="display:flex;flex-direction:row;gap:8px;align-items:center;">
															<label for="match_date_specify_day_value">Value</label>
															<div class="select-container">
																<select id="match_date_specify_day_value" v-model="store.selection.event.match.date.day.value">
																	<option value="Sun">Sun</option>
																	<option value="Mon">Mon</option>
																	<option value="Tue">Tue</option>
																	<option value="Wed">Wed</option>
																	<option value="Thu">Thu</option>
																	<option value="Fri">Fri</option>
																	<option value="Sat">Sat</option>
																</select>
															</div>
														</div>
														<div style="display:flex;flex-direction:row;gap:8px;align-items:center;">
															<label for="match_date_specify_day_ordinal">Ordinal</label>
															<input type="number" min="1" max="5" step="1" id="match_date_specify_day_ordinal" v-model="store.selection.event.match.date.day.ordinal"/>
														</div>
													</template>
												</div>
											</template>
											<template v-else-if="store.selection.event.match.date.type == 'easter'">
												<div style="display:flex;flex-direction:row;gap:8px;align-items:center;">
													<label for="match_date_easter_variant">Variant</label>
													<div class="select-container">
														<select id="match_date_easter_variant" v-model="store.selection.event.match.date.variant">
															<option value="western">Western</option>
														</select>
													</div>
												</div>
											</template>
										</div>
									</div>
									<div class="inset-flat-container" style="display:flex;flex-direction:column;flex-grow:1;align-items:center">
										<h5 class="inset-flat-heading" style="margin:0;">Time</h5>
										<div class="inset-flat" style="display:flex;flex-direction:row;gap:16px;flex-wrap:wrap;align-items:flex-start;">
											<div style="display:flex;flex-direction:row;gap:8px;align-items:center;">
												<label for="match_time_type">Type</label>
												<div class="select-container">
													<select id="match_time_type" v-model="store.selection.event.match.time.type">
														<option value="specify">specify</option>
														<option value="sun">solar</option>
													</select>
												</div>
											</div>
											<template v-if="store.selection.event.match.time.type == 'specify'">
												<div style="display:flex;flex-direction:column;gap:8px;">
													<h5 style="margin:0;">Hour</h5>
													<div style="display:flex;flex-direction:row;gap:8px;align-items:center;">
														<label for="match_time_specify_hour_type">Type</label>
														<div class="select-container">
															<select id="match_time_specify_hour_type" v-model="store.selection.event.match.time.hour.type">
																<option value="all">all</option>
																<option value="specify">specify</option>
															</select>
														</div>
													</div>
													<template v-if="store.selection.event.match.time.hour.type == 'specify'">
														<div style="display:flex;flex-direction:row;gap:8px;align-items:center;">
															<label for="match_time_specify_hour_format">Format</label>
															<div class="select-container">
																<select id="match_time_specify_hour_format" v-model="store.selection.event.match.time.hour.format">
																	<option value="meridian">12-hr</option>
																	<option value="military">24-hr (military)</option>
																</select>
															</div>
														</div>
														<template v-if="store.selection.event.match.time.hour.format == 'meridian'">
															<div style="display:flex;flex-direction:row;gap:8px;align-items:center;">
																<label for="match_time_specify_hour_value">Value</label>
																<input type="number" min="1" max="12" step="1" id="match_time_specify_hour_value" v-model="store.selection.event.match.time.hour.value"/>
															</div>
														</template>
														<template v-else-if="store.selection.event.match.time.hour.format == 'military'">
															<div style="display:flex;flex-direction:row;gap:8px;align-items:center;">
																<label for="match_time_specify_hour_value">Value</label>
																<input type="number" min="0" max="23" step="1" id="match_time_specify_hour_value" v-model="store.selection.event.match.time.hour.value"/>
															</div>
														</template>
													</template>
												</div>
												<div style="display:flex;flex-direction:column;gap:8px;">
													<h5 style="margin:0;">Minute</h5>
													<div style="display:flex;flex-direction:row;gap:8px;align-items:center;">
														<label for="match_time_specify_minute_type">Type</label>
														<div class="select-container">
															<select id="match_time_specify_minute_type" v-model="store.selection.event.match.time.minute.type">
																<option value="specify">specify</option>
															</select>
														</div>
													</div>
													<div style="display:flex;flex-direction:row;gap:8px;align-items:center;">
														<label for="match_time_specify_minute_value">Value</label>
														<input type="number" min="0" max="59" step="1" id="match_time_specify_minute_value" v-model="store.selection.event.match.time.minute.value"/>
													</div>
												</div>
											</template>
											<template v-else-if="store.selection.event.match.time.type == 'sun'">
												<div style="display:flex;flex-direction:row;gap:8px;align-items:center;">
													<label for="match_time_sun_event">Event</label>
													<div class="select-container">
														<select id="match_time_sun_event" v-model="store.selection.event.match.time.event">
															<option value="rise">rise</option>
															<option value="set">set</option>
														</select>
													</div>
												</div>
												<div style="display:flex;flex-direction:row;gap:8px;align-items:center;">
													<label for="match_time_sun_offset">Offset</label>
													<input type="number" step="1" id="match_time_sun_offset" v-model="store.selection.event.match.time.offset"/>
												</div>
											</template>
										</div>
									</div>
								</div>
								<div class="fieldset" style="margin-bottom:16px;">
									<h4>Sound File</h4>
									<div style="display:flex;flex-direction:column;gap:16px;width:100%;">
										<div style="display:flex;flex-direction:column;gap:4px;align-items:flex-start;">
											<label for="file_relative">Relative to</label>
											<div class="select-container">
												<select id="file_relative" v-model="store.selection.event.file.relative_to">
													<option value="clockworth">Clockworth folder</option>
													<option value="home">User home</option>
													<option value="root">Filesystem root</option>
												</select>
											</div>
										</div>
										<div style="display:flex;flex-direction:column;gap:4px;align-items:flex-start;">
											<label for="file_path">Path</label>
											<input type="text" id="file_path" v-model="store.selection.event.file.path" style="width:100%;"/>
										</div>
									</div>
								</div>
							</template>
						</div>
					</div>
					<div style="display:flex;flex-direction:row;justify-content:flex-end;">
						<button @click="page++;" style="display:flex;flex-direction:row;gap:8px;font-size:18px;">
							<svg viewBox="0 0 24 24" style="width:1em;height:1em;">
								<use href="img/icons.svg#export"/>
							</svg>
							<span>Export JSON</span>
						</button>
					</div>
				</template>
				<template v-else-if="page==2">
					<div style="display:flex;flex-direction:column;gap:12px;">
						<div style="display:flex;flex-direction:row;justify-content:flex-start;">
							<button class="secondary" @click="page--;" style="font-size:18px;">&larr; Back</button>
						</div>
						<textarea id="json_output" readonly>{{ jsonOutput }}</textarea>
						<div style="display:flex;flex-direction:row;justify-content:space-between;gap:12px;">
							<button style="flex:1;font-size:18px;" @click="copyJsonOutput();" :disabled="clipboardFeedback">
								<div v-if="clipboardFeedback" style="display:flex;flex-direction:row;gap:8px;">
									<svg viewBox="0 0 24 24" style="width:1em;height:1em;">
										<use href="img/icons.svg#checkmark"/>
									</svg>
									<span>Copied!</span>
								</div>
								<div v-else style="display:flex;flex-direction:row;gap:8px;">
									<svg viewBox="0 0 24 24" style="width:1em;height:1em;">
										<use href="img/icons.svg#clipboard"/>
									</svg>
									<span>Copy</span>
								</div>
							</button>
							<button style="flex:1;display:flex;flex-direction:row;gap:8px;font-size:18px;" @click="downloadJsonOutput();">
								<svg viewBox="0 0 24 24" style="width:1em;height:1em;">
									<use href="img/icons.svg#download"/>
								</svg>
								<span>Download</span>
							</button>
						</div>
					</div>
				</template>
			</main>
			<footer>
				<p>Copyright &copy; 2025 by Peter Markley.<br>Code published <a href="https://github.com/petermarkley/clockworth-conf">on Github</a> under the <a href="https://www.gnu.org/licenses/lgpl-3.0.en.html">GNU Lesser General Public License v3.0</a>.</p>
			</footer>
			<div v-cloak v-show="store.modal.show">
				<div id="modal" :style="'top:'+(store.modal.scroll)+'px'">
					<div id="modal-bg" @click="store.hideModal"></div>
					<form id="modal-panel">
						<div style="display:flex;flex-direction:row;gap:16px;align-items:center;">
							<a @click="store.hideModal" title="Close" style="font-size:28px;">
								<svg viewBox="0 0 24 24" style="width:1em;height:1em;">
									<use href="img/icons.svg#x"/>
								</svg>
							</a>
							<h2>{{ store.modal.title }}</h2>
						</div>
						<div style="max-height:calc( 80vh - 140px );overflow-y:auto;">
							<div v-if="store.modal.contentKey == 'uploadConf'" style="display:flex;flex-direction:column;gap:32px;align-items:center;">
								<p style="margin:0;">Please only upload files that were created using this GUI.</p>
								<input type="file" id="upload_conf_file" name="upload_conf_file" accept="application/json" style="margin-bottom:16px;">
							</div>
							<div v-else-if="store.modal.contentKey == 'newEvent'" style="display:flex;flex-direction:column;gap:16px;">
								<fieldset>
									<h4>Type</h4>
									<div title="Group" style="display:flex;flex-direction:row;gap:8px;align-items:center;cursor:pointer;">
										<input type="radio" id="newevent_type_group" name="newevent_type" value="group" style="cursor:pointer;"/>
										<label for="newevent_type_group" style="font-size:54px;cursor:pointer;">
											<svg viewBox="0 0 24 24" style="width:1em;height:1em;">
												<use href="img/icons.svg#folder"/>
											</svg>
										</label>
									</div>
									<div title="Event" style="display:flex;flex-direction:row;gap:8px;align-items:center;cursor:pointer;">
										<input type="radio" id="newevent_type_event" name="newevent_type" value="event" style="cursor:pointer;" checked/>
										<label for="newevent_type_event" style="font-size:54px;cursor:pointer;">
											<svg viewBox="0 0 24 24" style="width:1em;height:1em;">
												<use href="img/icons.svg#music"/>
											</svg>
										</label>
									</div>
								</fieldset>
								<div style="display:flex;flex-direction:column;gap:8px;padding:8px;">
									<label for="newevent_parent">Parent</label>
									<div class="select-container">
										<select
											id="newevent_parent"
											name="newevent_parent"
											:value="(store.selection.event == null ? -1 : (store.selection.event.type=='group' ? store.selection.path.length-1 : store.selection.path.length-2))"
										>
											<option value="-1" data-path="[]">(Root)</option>
											<template v-for="(item, i) in store.selection.path">
												<option
													v-if="item.event.type=='group'"
													:value="i"
													:data-path="JSON.stringify(store.cleanPath().slice(0,i+1))"
												>{{ item.event.label }}</option>
											</template>
										</select>
									</div>
								</div>
								<div style="display:flex;flex-direction:column;gap:8px;padding:8px;margin-bottom:16px;">
									<label for="newevent_label">Label</label>
									<input type="text" id="newevent_label" name="newevent_label" value="(Untitled)"/>
								</div>
							</div>
							<div v-else-if="store.modal.contentKey == 'deleteEvent'">
								<p
									v-if="store.selection.event !== null && store.selection.event.type == 'group'"
									style="margin-top:0;"
								>{{ getEventCount(store.selection.event) }} events inside this group will also be deleted.</p>
								<p style="margin-top:0;">Are you sure?</p>
							</div>
							<div v-else-if="store.modal.contentKey == 'overlapSlotsHelp'">
								<p style="margin-top:0;">Overlap slots let you control what happens if two or more chime events are triggered on the same minute.</p>
								<p>It works by these rules:</p>
								<ul style="display:flex;flex-direction:column;gap:16px;">
									<li>Each minute, Clockworth steps through the sequence of 10 slots. For each slot, it plays either nothing or a <strong>maximum of one matching chime.</strong></li>
									<li>If two or more chimes match on the same minute in the <em>same</em> slot, only the one shown last will play; this will <strong>override the others.</strong></li>
									<li>If two or more chimes match on the same minute in <em>different</em> slots, they will play <strong>in the order of their slot number.</strong></li>
									<li>The order of chimes inside a given overlap slot is dictated by their order in the master list of chime events.</li>
								</ul>
								<p>Let's take a more practical look at what all that means &hellip;</p>
								<p>If you know that two chimes will never match on the same minute, then putting them in the same slot together will essentially have no effect. For example, we know that the 1:00 chime and the 2:00 chime <em>by definition</em> can never both trigger at once. Likewise with any sunset chime and any sunrise chime.</p>
								<p>On the other hand, a sunrise chime might plausibly overlap with almost any chime in the "Westminster Quarters" group. Therefore, placing this in a later slot will ensure they can both play when appropriate: the sunrise chime after the Westminster Quarter chime.</p>
							</div>
						</div>
						<div style="display:flex;flex-direction:row;gap:12px;">
							<button style="flex:1;" @click.prevent="store.hideModal();" class="secondary">{{ store.modal.cancelLabel }}</button>
							<button
								style="flex:1;"
								@click.prevent="if (store.modal.confirmFunction !== null) {store.modal.confirmFunction();} store.hideModal();"
							>{{ store.modal.buttonLabel }}</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<script type="module">
import { createApp, ref, reactive } from 'https://unpkg.com/vue@3.5.13/dist/vue.esm-browser.js'

const store = reactive({
  // This is the payload that this widget exists to build, the Clockworth config data
  conf: {
    location: "",
    tick: true,
    chime: true,
    events: []
  },
  // Current GUI selection
  selection: {
    path: [],
    event: null
  },
  // Modal state
  modal: {
    show: false,
    title: "",
    confirmFunction: null,
    scroll: -1,
    buttonLabel: "Okay",
    cancelLabel: "Cancel",
    contentKey: null
  },
  // Returns a path object with no 'event' objects inside it
  cleanPath() {
    let cleanedPath = [];
    let index = 0;
    for (let i=0; i < store.selection.path.length; i++) {
      cleanedPath[index] = JSON.parse(JSON.stringify(store.selection.path[i]));
      if (typeof cleanedPath[index].event !== "undefined") {
        delete cleanedPath[index].event;
      }
      index++;
    }
    return cleanedPath;
  },
  // Update GUI selection
  select(e) {
    // get context from clicked DOM element
    let bar = null;
    if (e.target.classList.contains('selectable')) {
      bar = e.target;
    } else {
      bar = e.target.closest('.selectable');
    }
    let path = JSON.parse(bar.dataset.path);
    store.selection.path = path;
    // follow path to specific selected item
    let event = null;
    let list = store.conf.events;
    for (let i=0; i < path.length; i++) {
      for (let j=0; j < list.length; j++) {
        if (j==path[i].index) {
          event = list[j];
          store.selection.path[i].event = event;
          list = event.members;
          break;
        }
      }
    }
    store.selection.event = event;
  },
  // Reset GUI selection
  deselect() {
    store.selection.path = [];
    store.selection.event = null;
  },
  // Show modal
  showModal({
    title,
    buttonLabel = "Okay",
    cancelLabel = "Cancel",
    confirmFunction,
    contentKey
  }) {
    store.modal.show = true;
    store.modal.contentKey = contentKey;
    store.modal.scroll = Math.round(window.scrollY);
    if (typeof title !== "undefined" && title !== null) {
      store.modal.title = title;
    }
    if (typeof confirmFunction !== "undefined" && confirmFunction !== null) {
      store.modal.confirmFunction = confirmFunction;
    }
    store.modal.cancelLabel = cancelLabel;
    store.modal.buttonLabel = buttonLabel;
  },
  // Hide modal
  hideModal() {
    store.modal.show = false;
    store.modal.title = "";
    store.modal.confirmFunction = null;
  },
  // Add new chime event
  newEvent() {
    store.showModal({
      title: "New Chime Object",
      contentKey: 'newEvent',
      confirmFunction: () => {
        // collect data from form
        const form = document.getElementById("modal-panel");
        const data = new FormData(form);
        const parentOption = document.querySelector("#newevent_parent").selectedOptions[0];
        const parentPath = JSON.parse(parentOption.dataset.path);
        // descend tree to the selected parent
        let parent = store.conf;
        let prop = "events";
        for (let i=0; i < parentPath.length; i++) {
          parent = parent[prop][parentPath[i].index];
          prop = "members";
          // save this for later
          parentPath[i].event = parent;
        }
        // define new chime object
        const newObject = {
          enable: true,
          label: data.get('newevent_label'),
          type: data.get('newevent_type')
        };
        if (data.get('newevent_type') == 'group') {
          newObject.members = [];
        } else {
          newObject.sequence = 1;
          newObject.match = {
            date: {
              type: 'all'
            },
            time: {
              type: 'specify',
              hour: {
                type: 'all'
              },
              minute: {
                type: 'specify',
                value: 0
              }
            }
          };
          newObject.file = {
            relative_to: 'clockworth',
            path: 'sounds/drafts/westminster_15.wav'
          };
        }
        // insert into parent list
        parent[prop].push(newObject);
        // select new object
        store.selection.path = parentPath.concat({
          index: parent[prop].length-1,
          label: newObject.label,
          event: newObject
        });
        store.selection.event = newObject;
      }
    });
  },
  // Delete selected chime event
  deleteEvent() {
    store.showModal({
      title: "Delete \""+store.selection.event.label+"\"",
      contentKey: 'deleteEvent',
      buttonLabel: 'Delete',
      confirmFunction: () => {
        const pathEnd = store.selection.path[store.selection.path.length-1];
        const index = pathEnd.index;
        if (store.selection.path.length > 1) {
          const parent = store.selection.path[store.selection.path.length-2].event;
          parent.members.splice(index, 1);
        } else {
          store.conf.events.splice(index, 1);
        }
        store.deselect();
      }
    });
  },
  // Move chime event upward in hierarchy
  decreaseIndent() {
    alert("decrease indent");
  },
  // Move chime event downward in hierarchy
  increaseIndent() {
    alert("increase indent");
  },
  // Move selected chime event upward in list
  moveUpward() {
    if (store.selection.event === null) {
      return;
    }
    const pathEnd = store.selection.path[store.selection.path.length-1];
    const index = pathEnd.index;
    if (index < 1) {
      return;
    }
    if (store.selection.path.length > 1) {
      const parent = store.selection.path[store.selection.path.length-2].event;
      const swap = parent.members[index-1];
      parent.members[index-1] = parent.members[index];
      parent.members[index] = swap;
    } else {
      const swap = store.conf.events[index-1];
      store.conf.events[index-1] = store.conf.events[index];
      store.conf.events[index] = swap;
    }
    pathEnd.index--;
  },
  // Move selected chime event downward in list
  moveDownward() {
    if (store.selection.event === null) {
      return;
    }
    const pathEnd = store.selection.path[store.selection.path.length-1];
    const index = pathEnd.index;
    if (store.selection.path.length > 1) {
      const parent = store.selection.path[store.selection.path.length-2].event;
      if (index >= parent.members.length-1) {
        return;
      }
      const swap = parent.members[index+1];
      parent.members[index+1] = parent.members[index];
      parent.members[index] = swap;
    } else {
      if (index >= store.conf.length-1) {
        return;
      }
      const swap = store.conf.events[index+1];
      store.conf.events[index+1] = store.conf.events[index];
      store.conf.events[index] = swap;
    }
    pathEnd.index++;
  },
});

// Root component
const app = createApp({
  data() {
    return {
      // The widget has three pages, or steps, that the user progresses through
      page: 0,
      // Just a value used for fancy GUI feedback
      clipboardFeedback: false
    };
  },
  setup() {
    return { store };
  },
  computed: {
    // Serialized payload for when the user is finished
    jsonOutput() {
      return JSON.stringify(store.conf);
    }
  },
  methods: {
    // On page 0, if the user opts to start with a default config ...
    importDefault() {
      let xhr = new XMLHttpRequest();
      let url = 'default.json';
      //let url = 'https://raw.githubusercontent.com/petermarkley/clockworth-conf/refs/heads/master/default.json';
      xhr.open('GET', url, true);
      xhr.responseType = 'json';
      xhr.onload = () => {
        if (xhr.status === 200) {
          store.conf = xhr.response;
        } else {
          console.log("HTTP response "+xhr.status);
        }
      };
      xhr.send();
    },
    // On page 0, if the user opts to upload a pre-existing conf file ...
    uploadConf() {
      store.showModal({
        title: "Upload Existing Config",
        confirmFunction: () => {
          let inp = document.getElementById("upload_conf_file");
          if (inp.files.length < 1) {
            return;
          }
          let file = inp.files[0];
          let url = URL.createObjectURL(file);
          let xhr = new XMLHttpRequest();
          xhr.open('GET', url, true);
          xhr.responseType = 'json';
          xhr.onload = () => {
            if (xhr.status === 200) {
              store.conf = xhr.response;
            } else {
              console.log("HTTP response "+xhr.status);
            }
            URL.revokeObjectURL(url);
          };
          xhr.send();
          this.page++;
        },
        contentKey: 'uploadConf'
      });
    },
    // Show "Overlap Slots" help message
    overlapSlotsHelp() {
      store.showModal({
        title: "What are \"Overlap Slots?\"",
        confirmFunction: null,
        contentKey: 'overlapSlotsHelp'
      });
    },
    // Return number of chime events inside group
    getEventCount(group) {
      if (group.type != 'group' || typeof group.members === "undefined") {
        return 0;
      }
      let count = 0;
      for (let i=0; i < group.members.length; i++) {
        if (group.members[i].type == 'group') {
          count += this.getEventCount(group.members[i]);
        } else {
          count++;
        }
      }
      return count;
    },
    // Return list of all chime events matching the given sequence slot, recursively searching groups
    getCollisionList(n,events,enable,path) {
      let list = [];
      for (let i=0; i < events.length; i++) {
        let newPath = path.concat({
          index: i,
          label: events[i].label
        });
        if (events[i].type == 'group') {
          // for groups, descend and gather and matches within
          list.push(
            ...this.getCollisionList(
              n,
              events[i].members,
              (enable && events[i].enable),
              newPath
            )
          );
        } else if (events[i].type == 'event') {
          // if this is a match, add it
          if (events[i].sequence == n) {
            list.push({
              enable: (enable && events[i].enable),
              path: newPath,
              event: events[i]
            });
          }
        }
      }
      return list;
    },
    // On page 2, if the user opts to copy payload to clipboard ...
    copyJsonOutput() {
      let element = document.getElementById("json_output");
      element.select();
      document.execCommand('copy');
      this.clipboardFeedback = true;
      setTimeout(() => {this.clipboardFeedback = false;}, 1000);
    },
    // On page 2, if the user opts to directly download the payload as a Clockworth-ready config file ...
    downloadJsonOutput() {
      let output = document.getElementById("json_output");
      let anchor = document.createElement('a');
      anchor.setAttribute('href', 'data:application/json,' + output.value);
      anchor.setAttribute('download', "clockworth.json");
      anchor.style.display = 'none';
      document.body.appendChild(anchor);
      anchor.click();
      document.body.removeChild(anchor);
    }
  }
});

// Component for a chime event (or group) in the master list (the pane on the left).
// If event.type=='group', this component is recursive.
app.component('chime-event', {
  name: 'ChimeEvent',
  props: [
    'event', // the chime event
    'index', // index in the parent's member list
    'depth', // current depth of hierarchy
    'has-next-sibling', // false if last in parent's member list
    'path' // path from root of event hierarchy
  ],
  data() {
    return {
      open: true // GUI state to make groups collapsible
    };
  },
  setup() {
    return { store };
  },
  computed: {
    // Augmented path that includes this chime event
    nextPath() {
      return this.path.concat({
        index: this.index,
        label: this.event.label,
        hasNextSibling: this.hasNextSibling
      });
    }
  },
  template: '<li v-if="event.type == \'group\'" style="position:relative" :class="event.enable?\'\':\'disable\'"> \
      <div class="event-heading"> \
        <span :class="\'drawer-button \' + (open ? \'open\' : \'\')" @click="open = !open">&#x25B8;</span> \
        <div :class="\'event-bar selectable\'+(store.selection.event===event?\' selected\':\'\')" @click="store.select" :data-path="JSON.stringify(nextPath)"> \
          <span> \
            <svg viewBox="0 0 24 24" style="width:1em;height:1em;"> \
              <use href="img/icons.svg#folder"/> \
            </svg> \
          </span> \
          <span>{{ event.label }}</span> \
        </div> \
        <svg v-if="!event.enable" viewBox="0 0 24 24" style="width:1em;height:1em;"> \
          <use href="img/icons.svg#hidden"/> \
        </svg> \
      </div> \
      <ul v-if="event.members.length > 0" :class="open ? \'open\':\'\'"> \
        <chime-event v-for="(member, subindex) in event.members" :event="member" :index="subindex" :depth="depth+1" :has-next-sibling="subindex < event.members.length-1" :path="nextPath"></chime-event> \
      </ul> \
      <hierarchy-lines v-if="depth>0" :index="index" :depth="depth" :path="path"></hierarchy-lines> \
    </li> \
    <li v-else-if="event.type == \'event\'" style="position:relative" :class="event.enable?\'\':\'disable\'"> \
      <div class="event-heading"> \
        <div :class="\'event-bar selectable\'+(store.selection.event===event?\' selected\':\'\')" @click="store.select" :data-path="JSON.stringify(nextPath)"> \
          <span> \
            <svg viewBox="0 0 24 24" style="width:1em;height:1em;"> \
              <use href="img/icons.svg#music"/> \
            </svg> \
          </span> \
          <span>{{ event.label }}</span> \
        </div> \
        <svg v-if="!event.enable" viewBox="0 0 24 24" style="width:1em;height:1em;"> \
          <use href="img/icons.svg#hidden"/> \
        </svg> \
      </div> \
      <hierarchy-lines v-if="depth>0" :index="index" :depth="depth" :path="path"></hierarchy-lines> \
    </li>'
});

// Purely graphical component for drawing hierarchy lines
app.component('hierarchy-lines', {
  name: 'HierarchyLines',
  props: [
    'depth', // current depth of hierarchy
    'index', // index in the parent's member list
    'path' // data about ancestors in the hierarchy
  ],
  template: '<template v-for="(item, i) in path"> \
      <div v-if="item.hasNextSibling" class="hierarchy-parent" :style="\'left:\'+((depth-i+1)*-26+4)+\'px;\'"></div> \
    </template> \
    <div class="hierarchy-item" v-if="index==0" style="height:1em;top:0;"></div> \
    <div class="hierarchy-item" v-else style="height:3em;top:-2em;"></div>'
});

window.vm = app.mount('#app');
		</script>
	</body>
</html>

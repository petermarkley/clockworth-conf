<!DOCTYPE html>
<html>
	<head>
		<title>Clockworth Configurator</title>
		<style>
			body {
				background-color: #393836;
				background-image: url("img/clockworth-paper-bg.jpg");
				background-position: top center;
				background-repeat: no-repeat;
				background-size: cover;
				color: #b6b6b6;
				font-family: Baskerville, serif;
				padding: 0;
				margin: 0;
			}
			a {
				color: #fff;
				text-decoration: none;
				cursor: pointer;
			}
			a:hover, a:active, a:focus {
				color: #ddd;
			}
			main {
				max-width: 800px;
				margin: 16px auto;
				background-color: #323232;
				padding: 16px;
				border-radius: 8px;
				box-shadow: 0 4px 8px rgba(0,0,0,0.5);
			}
			h1 {
				font-family: "Brush Script MT", cursive;
				font-size: 48px;
				margin: 0;
				text-align: center;
				font-style: italic;
			}
			h2 {
				text-align: center;
				margin: 0 0 8px 0;
				font-weight: normal;
				font-size: 24px;
				letter-spacing: 4px;
			}
			h3 {
				margin: 0;
			}
			footer {
				font-size: 1em;
				font-style: italic;
				color: rgba(255,255,255,0.4);
				text-align: center;
			}
			footer a {
				color: rgba(255,255,255,0.8);
			}
			footer a:hover, footer a:active, footer a:focus {
				color: rgba(255,255,255,0.6);
			}
			.inset {
				background-color: #2c2c2c;
				box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
				padding: 8px;
				border-radius: 4px;
				overflow-y: scroll;
				margin: 0 0 8px 0;
			}
			#chime_events, #chime_events ul {
				list-style-type: none;
				padding: 0;
				margin: 0;
				display: flex;
				flex-direction: column;
				gap: 4px;
				overflow: visible;
			}
			#chime_events ul {
				padding: 0 0 0 26px;
				margin: 0;
				/*border-left: 2px solid #4d4d4c;*/
			}
			#chime_events li {
				margin: 0;
				padding: 0;
				display: flex;
				flex-direction: column;
				gap: 4px;
				align-items: flex-start;
			}
			.event-heading {
				display: flex;
				flex-direction: row;
				gap: 8px;
			}
			.drawer-button {
				cursor: pointer;
			}
			.drawer-button.open {
				transform: rotate(90deg);
			}
			#chime_events ul {
				display: none;
				transform: scaleY(0);
			}
			#chime_events ul.open {
				display: flex;
				transform: scaleY(1.0);
			}
			.event-bar {
				margin: 0;
				padding: 4px 8px;
				background-color: #393836;
				border-radius: 8px;
				cursor: pointer;
			}
			.event-bar:hover {
				background-color: #4d4d4c;
			}
			.event-bar.selected {
				background-color: #b6b6b6;
				color: #393836;
			}
			.event-bar.selected:hover {
				background-color: #fff;
			}
			.hierarchy-parent {
				position: absolute;
				pointer-events: none;
				top: -2em;
				height: 3em;
				box-sizing: border-box;
				border-left: 2px solid #4d4d4c;
			}
			.hierarchy-item {
				position: absolute;
				pointer-events: none;
				left: -22px;
				top: -2em;
				width: 12px;
				height: 3em;
				box-sizing: border-box;
				border-bottom: 2px solid #4d4d4c;
				border-left: 2px solid #4d4d4c;
				border-bottom-left-radius: 8px;
			}
			button {
				appearance: none;
				border: none;
				background-color: #b6b6b6;
				color: #393836;
				margin: 0;
				padding: 8px;
				display: flex;
				justify-content: center;
				align-items: center;
				border-radius: 4px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.5);
				cursor: pointer;
			}
			button:hover, button:focus {
				background-color: #fff;
			}
			button:active {
				background-color: #b6b6b6;
				box-shadow: 0 1px 2px rgba(0,0,0,1.0);
				transform: translate( 0, 1px );
			}
			button:disabled {
				background-color: #b6b6b6;
				opacity: 0.5;
				cursor: default;
				transform: none;
			}
			button.secondary {
				background-color: #393836;
				color: #fff;
			}
			button.secondary:hover, button.secondary:focus {
				background-color: #4d4d4c;
			}
			button.secondary:active {
				background-color: #393836;
			}
			button.secondary:disabled {
				background-color: #393836;
			}
			.toolbar {
				display: flex;
				flex-direction: row;
				gap: 4px;
			}
			.toolbar button {
				appearance: none;
				border: none;
				background-color: #393836;
				color: #fff;
				margin: 0;
				width: 48px;
				height: 40px;
				display: flex;
				justify-content: center;
				align-items: center;
				border-radius: 4px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.5);
				cursor: pointer;
			}
			.toolbar button:hover, .toolbar button:focus {
				background-color: #4d4d4c;
			}
			.toolbar button:active {
				background-color: #393836;
				box-shadow: 0 1px 2px rgba(0,0,0,1.0);
				transform: translate( 0, 1px );
			}
			.toolbar button.leftmost {
				border-bottom-left-radius: 8px;
			}
			.toolbar button.rightmost {
				border-bottom-right-radius: 8px;
			}
			.toolbar button:disabled {
				background-color: #393836;
				opacity: 0.5;
				cursor: default;
				transform: none;
			}
			.properties_heading {
				display: flex;
				flex-direction: row;
				justify-content: space-between;
				border-bottom: 1px solid #4d4d4c;
				padding-bottom: 16px;
				flex-grow: 1;
			}
			#breadcrumb {
				font-size: 12px;
				font-weight: normal;
			}
			#properties_title {
				appearance: none;
				border: none;
				background: none;
				font-size: 19px;
				font-weight: bold;
				color: #b6b6b6;
				font-family: inherit;
				width: auto;
			}
			#properties_type {
				font-weight: normal;
				font-style: italic;
			}
			#properties {
				min-height: 300px;
			}
			
			/* input toggle */
			.switch {
				position: relative;
				display: inline-block;
				width: 60px;
				height: 34px;
			}
			.switch input {
				opacity: 0;
				width: 0;
				height: 0;
			}
			.slider {
				position: absolute;
				cursor: pointer;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: #4d4d4c;
				-webkit-transition: .4s;
				transition: .4s;
				border-radius: 34px;
				box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
			}
			.slider:before {
				position: absolute;
				content: "";
				height: 26px;
				width: 26px;
				left: 4px;
				bottom: 4px;
				background-color: #323232;
				-webkit-transition: .4s;
				transition: .4s;
				border-radius: 50%;
				box-shadow: 0 1px 2px rgba(0,0,0,0.5);
			}
			input:checked + .slider {
				background-color: #b6b6b6;
			}
			input:focus + .slider {
				box-shadow: 0 0 1px #b6b6b6;
			}
			input:checked + .slider:before {
				-webkit-transform: translateX(26px);
				-ms-transform: translateX(26px);
				transform: translateX(26px);
			}
			#json_output {
				color: inherit;
				font-weight: bold;
				width: 100%;
				height: 150px;
				box-sizing: border-box;
				resize: none;
				appearance: none;
				border: none;
				border-radius: 4px;
				background-color: #2c2c2c;
				box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
				padding: 8px;
				border-radius: 4px;
				overflow-y: scroll;
			}
		</style>
	</head>
	<body>
		<main id="app">
			<div style="display:flex;flex-direction:column;align-items:center;margin-bottom:16px;">
				<h1>Clockworth Configurator</h1>
				<p>Widget for configuring your own <a href="https://github.com/petermarkley/clockworth">Clockworth robotic clock</a>.</p>
				<img src="img/clockworth-photo-alpha-300px.png" alt="Clockworth" style="width:200px;height:auto;"/>
			</div>
			<template v-if="page==0">
				<div style="display:flex;flex-direction:column;align-items:center;margin-bottom:16px;gap:16px;">
					<p>Lorem ipsum dolor sit amet.</p>
					<div style="display:flex;flex-direction:row;justify-content:space-between;gap:12px;width:100%;">
						<button @click="importDefault(); page++;" style="flex:1;">Use Default</button>
						<button @click="page++;" style="flex:1;">Start from Scratch</button>
					</div>
				</div>
			</template>
			<template v-else-if="page==1">
				<div style="display:flex;flex-direction:row;gap:16px;margin-bottom:24px;">
					<div style="width:100%;">
						<h2>Chime Events</h2>
						<div class="inset" style="height:300px;">
							<ul id="chime_events">
								<chime-event v-for="(event, index) in store.conf.events" :event="event" :index="index" :depth="0" :has-next-sibling="false" :path="[]"></chime-event>
							</ul>
						</div>
						<div class="toolbar">
							<button id="toolbar_add" class="leftmost">
								<span>+</span>
							</button>
							<button id="toolbar_remove">
								<span>-</span>
							</button>
							<button id="toolbar_unindent">
								<span>&larr;</span>
							</button>
							<button id="toolbar_indent">
								<span>&rarr;</span>
							</button>
							<button id="toolbar_up">
								<span>&uarr;</span>
							</button>
							<button id="toolbar_down" class="rightmost">
								<span>&darr;</span>
							</button>
						</div>
					</div>
					<div style="width:100%;">
						<h2>Collision Sequence</h2>
						<div class="inset" style="height:300px;">
							<ul id="collision_sequence"></ul>
						</div>
						<div class="toolbar">
							<button id="toolbar_prev" class="leftmost">
								<span>&uarr;</span>
							</button>
							<button id="toolbar_next" class="rightmost">
								<span>&darr;</span>
							</button>
						</div>
					</div>
				</div>
				<div>
					<div style="display:flex;flex-direction:row;gap:16px;margin-bottom:16px;">
						<div class="properties_heading">
							<h3 style="display:flex;flex-direction:row;gap:16px;align-items:baseline;">
								<span id="breadcrumb"><a>Westminster Quarters</a> &rarr; <a>Quarter Hours</a> &rarr;</span>
								<input type="text" id="properties_title" value="Quarter-Hour"/>
								<span id="properties_type">[event]</span>
							</h3>
						</div>
						<label class="switch">
							<input type="checkbox" id="properties_enable">
							<span class="slider"></span>
						</label>
					</div>
					<div id="properties">
						
					</div>
				</div>
				<div style="display:flex;flex-direction:row;justify-content:flex-end;">
					<button @click="page++;">Export JSON</button>
				</div>
			</template>
			<template v-else-if="page==2">
				<div style="display:flex;flex-direction:column;gap:12px;">
					<div style="display:flex;flex-direction:row;justify-content:flex-start;">
						<button class="secondary" @click="page--;">&larr; Back</button>
					</div>
					<textarea id="json_output" readonly>{{ jsonOutput }}</textarea>
					<div style="display:flex;flex-direction:row;justify-content:space-between;gap:12px;">
						<button style="flex:1;" @click="copyJsonOutput();" :disabled="clipboardFeedback">
							<div v-if="clipboardFeedback" style="display:flex;flex-direction:row;gap:8px;">
								<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:1em;height:1em;">
									<path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 0 1 .208 1.04l-9 13.5a.75.75 0 0 1-1.154.114l-6-6a.75.75 0 0 1 1.06-1.06l5.353 5.353 8.493-12.74a.75.75 0 0 1 1.04-.207Z" clip-rule="evenodd" />
								</svg>
								<span>Copied!</span>
							</div>
							<div v-else style="display:flex;flex-direction:row;gap:8px;">
								<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:1em;height:1em;">
									<path d="M7.5 3.375c0-1.036.84-1.875 1.875-1.875h.375a3.75 3.75 0 0 1 3.75 3.75v1.875C13.5 8.161 14.34 9 15.375 9h1.875A3.75 3.75 0 0 1 21 12.75v3.375C21 17.16 20.16 18 19.125 18h-9.75A1.875 1.875 0 0 1 7.5 16.125V3.375Z" />
									<path d="M15 5.25a5.23 5.23 0 0 0-1.279-3.434 9.768 9.768 0 0 1 6.963 6.963A5.23 5.23 0 0 0 17.25 7.5h-1.875A.375.375 0 0 1 15 7.125V5.25ZM4.875 6H6v10.125A3.375 3.375 0 0 0 9.375 19.5H16.5v1.125c0 1.035-.84 1.875-1.875 1.875h-9.75A1.875 1.875 0 0 1 3 20.625V7.875C3 6.839 3.84 6 4.875 6Z" />
								</svg>
								<span>Copy</span>
							</div>
						</button>
						<button style="flex:1;display:flex;flex-direction:row;gap:8px;" @click="downloadJsonOutput();">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:1em;height:1em;">
								<path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
							</svg>
							<span>Download</span>
						</button>
					</div>
				</div>
			</template>
		</main>
		<footer>
			<p>Copyright &copy; 2025 by Peter Markley.<br>Code published <a href="https://github.com/petermarkley/clockworth-conf">on Github</a> under the <a href="https://www.gnu.org/licenses/lgpl-3.0.en.html">GNU Lesser General Public License v3.0</a>.</p>
		</footer>
<script type="module">
  import { createApp, ref, reactive } from 'https://unpkg.com/vue@3.5.13/dist/vue.esm-browser.js'
  
  const store = reactive({
    // This is the payload that this widget exists to build, the Clockworth config data
    conf: {
      location: "",
      tick: true,
      chime: true,
      events: []
    },
    // Current GUI selection
    selection: {
      path: [],
      event: null
    }
  });

  // Root component
  const app = createApp({
    data() {
      return {
        // The widget has three pages, or steps, that the user progresses through
        page: 0,
        // Just a value used for fancy GUI feedback
        clipboardFeedback: false
      };
    },
    setup() {
      return { store };
    },
    computed: {
      // Serialized payload for when the user is finished
      jsonOutput() {
        return JSON.stringify(store.conf);
      }
    },
    methods: {
      // On page 0, if the user opts to start with a default config ...
      importDefault() {
        let xhr = new XMLHttpRequest();
        //let url = 'default.json';
        let url = 'https://raw.githubusercontent.com/petermarkley/clockworth-conf/refs/heads/master/default.json';
        xhr.open('GET', url, true);
        xhr.responseType = 'json';
        xhr.onload = () => {
          if (xhr.status === 200) {
            store.conf = xhr.response;
          } else {
            console.log("HTTP response "+xhr.status);
          }
        };
        xhr.send();
      },
      // On page 2, if the user opts to copy payload to clipboard ...
      copyJsonOutput() {
        let element = document.getElementById("json_output");
        element.select();
        document.execCommand('copy');
        this.clipboardFeedback = true;
        setTimeout(() => {this.clipboardFeedback = false;}, 1000);
      },
      // On page 2, if the user opts to directly download the payload as a Clockworth-ready config file ...
      downloadJsonOutput() {
        let output = document.getElementById("json_output");
        let anchor = document.createElement('a');
        anchor.setAttribute('href', 'data:application/json,' + output.value);
        anchor.setAttribute('download', "clockworth.json");
        anchor.style.display = 'none';
        document.body.appendChild(anchor);
        anchor.click();
        document.body.removeChild(anchor);
      }
    }
  });
  
  // Component for a chime event (or group) in the master list (the pane on the left).
  // If event.type=='group', this component is recursive.
  app.component('chime-event', {
    name: 'ChimeEvent',
    props: [
      'event', // the chime event
      'index', // index in the parent's member list
      'depth', // current depth of hierarchy
      'has-next-sibling', // false if last in parent's member list
      'path' // path from root of event hierarchy
    ],
    data() {
      return {
        open: true // GUI state to make groups collapsible
      };
    },
    setup() {
      return { store };
    },
    computed: {
      // Augmented path that includes this chime event
      nextPath() {
        return this.path.concat({
          index: this.index,
          label: this.event.label,
          hasNextSibling: this.hasNextSibling
        });
      }
    },
    methods: {
      // Update GUI selection
      select(e) {
        // get context from clicked DOM element
        let bar = null;
        if (e.target.classList.contains('event-bar')) {
          bar = e.target;
        } else {
          bar = e.target.closest('.event-bar');
        }
        let path = JSON.parse(bar.dataset.path);
        store.selection.path = path;
        // follow path to specific selected item
        let event = null;
        let list = store.conf.events;
        for (let i=0; i < path.length; i++) {
          for (let j=0; j < list.length; j++) {
            if (j==path[i].index) {
              event = list[j];
              list = event.members;
              break;
            }
          }
        }
        store.selection.event = event;
      }
    },
    template: '<li v-if="event.type == \'group\'" style="position:relative"> \
        <div class="event-heading"> \
          <span :class="\'drawer-button \' + (open ? \'open\' : \'\')" @click="open = !open">&#x25B8;</span> \
          <div :class="\'event-bar\'+(store.selection.event===event?\' selected\':\'\')" @click="select" :data-path="JSON.stringify(nextPath)"> \
            <span> \
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:1em;height:1em;"> \
                <path d="M19.5 21a3 3 0 0 0 3-3v-4.5a3 3 0 0 0-3-3h-15a3 3 0 0 0-3 3V18a3 3 0 0 0 3 3h15ZM1.5 10.146V6a3 3 0 0 1 3-3h5.379a2.25 2.25 0 0 1 1.59.659l2.122 2.121c.14.141.331.22.53.22H19.5a3 3 0 0 1 3 3v1.146A4.483 4.483 0 0 0 19.5 9h-15a4.483 4.483 0 0 0-3 1.146Z" /> \
              </svg> \
            </span> \
            <span>{{ event.label }}</span> \
          </div> \
        </div> \
        <ul v-if="event.members.length > 0" :class="open ? \'open\':\'\'"> \
          <chime-event v-for="(member, subindex) in event.members" :event="member" :index="subindex" :depth="depth+1" :has-next-sibling="subindex < event.members.length-1" :path="nextPath"></chime-event> \
        </ul> \
        <hierarchy-lines v-if="depth>0" :index="index" :depth="depth" :path="path"></hierarchy-lines> \
      </li> \
      <li v-else-if="event.type == \'event\'" style="position:relative"> \
        <div class="event-heading"> \
          <div :class="\'event-bar\'+(store.selection.event===event?\' selected\':\'\')" @click="select" :data-path="JSON.stringify(nextPath)"> \
            <span> \
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:1em;height:1em;"> \
                <path fill-rule="evenodd" d="M19.952 1.651a.75.75 0 0 1 .298.599V16.303a3 3 0 0 1-2.176 2.884l-1.32.377a2.553 2.553 0 1 1-1.403-4.909l2.311-.66a1.5 1.5 0 0 0 1.088-1.442V6.994l-9 2.572v9.737a3 3 0 0 1-2.176 2.884l-1.32.377a2.553 2.553 0 1 1-1.402-4.909l2.31-.66a1.5 1.5 0 0 0 1.088-1.442V5.25a.75.75 0 0 1 .544-.721l10.5-3a.75.75 0 0 1 .658.122Z" clip-rule="evenodd" /> \
              </svg> \
            </span> \
            <span>{{ event.label }}</span> \
          </div> \
        </div> \
        <hierarchy-lines v-if="depth>0" :index="index" :depth="depth" :path="path"></hierarchy-lines> \
      </li>'
  });
  
  // Purely graphical component for drawing hierarchy lines
  app.component('hierarchy-lines', {
    name: 'HierarchyLines',
    props: [
      'depth', // current depth of hierarchy
      'index', // index in the parent's member list
      'path' // data about ancestors in the hierarchy
    ],
    template: '<template v-for="(item, i) in path"> \
        <div v-if="item.hasNextSibling" class="hierarchy-parent" :style="\'left:\'+((depth-i+1)*-24)+\'px;\'"></div> \
      </template> \
      <div class="hierarchy-item" v-if="index==0" style="height:1em;top:0;"></div> \
      <div class="hierarchy-item" v-else style="height:3em;top:-2em;"></div>'
  });
  
  window.vm = app.mount('#app');
</script>
	</body>
</html>
